{% block bnbc_ajax_file_widget %}
    {% spaceless %}    
    
    <div id="{{ id }}_bnbc_ajax_file_widget" class="bnbc-ajax-file-widget">  
    	{{ block('hidden_widget') }}
        {% set type = 'file' %}
        {% set original_id = id %}
        {% set id = 'bnbc_ajax_file_' ~ original_id %}
        {% set full_name = 'bnbc_ajax_file_' ~ full_name %}        

        {% if form.vars.multiple %}
        {%  set attr = {'multiple': form.vars.multiple} %}
        {% endif %}

        {{ block('form_widget_simple') }}  
        
        {% if form.vars.dropZone %}
        <div id="{{ id }}_dropzone" class="bnbc-ajax-file-dropzone">{{ form.vars.dropZoneText }}</div>
        {% endif %}

        <script type="text/javascript">
            {{ id }}_formData = [];
            {% for name, value in form.vars.formData %}
                {% if value %}
                    {{ id }}_formData.push({'name': '{{ name }}', value: '{{ value }}'});
                {% endif %}
            {% endfor %}

            if (typeof bnbc_ajax_file == 'undefined')
                bnbc_ajax_file = new Array();

            bnbc_ajax_file.push(function(){
                {# Fix refresh page #}
                $('#{{ original_id }}').val('');

                {# Call fileupload plugin #}
                $('#{{ id }}').fileupload({
                    url: '{{ path('bnbc_upload_default_index') }}',
                    dataType: 'json',
                    formData: {{ id }}_formData,
                    paramName: 'bnbc_ajax_file_form[]',
                    {% if form.vars.dropZone %}
                    dropZone: ('#{{ id }}_dropzone'),                    
                    {% endif %}
                    autoUpload: {{ form.vars.autoUpload }},
                    progressall: function (e, data) {
                        if(!$('#{{ id }}_progress').length)
                            $('#{{ original_id }}_bnbc_ajax_file_widget').append($('<div/>').attr('id', '{{ id }}_progress').addClass('bnbc-ajax-file-progress'));

                        var progress = parseInt(data.loaded / data.total * 100, 10);
                        $('#{{ id }}_progress').css(
                            'width',
                            progress + '%'
                        ).text(progress + '%');
                    },
                    done: function (e, data) { 
                        if(!$('#{{ id }}_list').length)
                            $('#{{ original_id }}_bnbc_ajax_file_widget').append($('<ul/>').attr('id', '{{ id }}_list').addClass('bnbc-ajax-file-list'));

                        $.each(data.result.bnbc_ajax_file_form, function (index, file) {
                            if(file.error){
                                var li = $('<li/>').html('<b>' + file.name + ':</b> ' + file.error).addClass('error');                                  
                            }
                            else {
                                $('#{{ original_id }}').val(bnbcAjaxFileSetValue($('#{{ original_id }}').val(), file.name, ';'));
                                var li = $('<li/>').html(file.name);                                   
                            }
                            $('#{{ id }}_list').append(li);   
                        });  
                        {% if form.vars.callbackFunction %}
                        {{callbackFunction}}();
                        {% endif %}  
                    }
                });
            });
        </script>
    </div>
    {% endspaceless %}
{% endblock %}